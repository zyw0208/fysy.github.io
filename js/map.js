var addresses = [
    // 主 国家级
    {
        name: "绍兴市文化馆",
        content: [
            { name: "童谣(绍兴童谣)", audio: "" },
            { name: "目连戏(绍兴目连戏)", audio: "" },
            { name: "绍兴平湖调", audio: "" },
            { name: "摊簧(绍兴摊簧)", audio: "" },
            { name: "绍兴词调", audio: "" },
        ],
        address: "浙江省绍兴市越城区人民西路26号绍兴市文化馆"
    },

    {
        name: "绍兴市柯桥区文化馆",
        content: [
            { name: "绍兴莲花落", audio: "" },
            { name: "绍兴宣卷", audio: "" },
        ],
        address: "浙江省绍兴市柯桥区群贤路与湖东路交叉口(柯桥区文化中心内)",
    },
    {
        name: "绍兴黄酒博物馆",
        content: [
            { name: "绍兴黄酒酿制技艺", audio: "" },
        ],
        address: "浙江省绍兴市越城区下大路557号",
    },
    {
        name: "绍兴虞舜文化研究会",
        content: [
            { name: "庙会(绍兴舜王庙会)", audio: "" },
        ],
        address: "浙江省绍兴市上虞区舜耕大道518号(上虞区文化艺术中心附近)",
    },
    // 省级
    {
        name: "越城区鲁迅中路318号",
        content: [
            { name: "绍兴艺兰", audio: "" },
        ],
        address: "浙江省绍兴市越城区鲁迅中路318号",
    },
    {
        name: "越城区鲁迅中路179号",
        content: [
            { name: "绍兴菜烹饪技艺", audio: "" },
        ],
        address: "浙江省绍兴市越城区鲁迅中路179号",
    },
    {
        name: "越城区鲁迅中路241号附近",
        content: [
            { name: "绍兴乌毡帽", audio: "" },
        ],
        address: "浙江省绍兴市越城区鲁迅中路241号",
    },
    {
        name: "越城区仓桥直街",
        content: [
            { name: "绍兴民间棋类游戏", audio: "" },
            { name: "会稽铜镜制造技艺", audio: "" },
            { name: "绍兴银饰品制作技艺", audio: "" },
            { name: "绍兴锡器制作技艺", audio: "" },
        ],
        address: "浙江省绍兴市越城区仓桥直街",
    },
    {
        name: "柯桥区安昌古镇",
        content: [
            { name: "绍兴清音班", audio: "" },
            { name: "绍兴修缸补甏技艺", audio: "" },
            { name: "绍兴乌毡帽", audio: "" },
            { name: "绍兴古戏台建筑艺术", audio: "" },
            { name: "绍兴水乡社戏", audio: "" },
            { name: "绍兴乌干菜制作与烹饪技艺", audio: "" },
            { name: "乌篷船制作技艺", audio: "" },
        ],
        address: "浙江省绍兴市柯桥区安昌古镇",
    },
    {
        name: "越城区兰花协会",
        content: [
            { name: "绍兴艺兰", audio: "" },
        ],
        address: "浙江省绍兴市越城区洋江西路530号",
    },
    {
        name: "绍兴市文化馆(新馆)",
        content: [
            { name: "绍兴派古琴艺术", audio: "" },
        ],
        address: "浙江省绍兴市越城区洋江西路530号绍兴市文化馆"
    },
    {
        name: "嵊州市谷来镇榆树村",
        content: [
            { name: "香榧传说", audio: "" },
        ],
        address: "浙江省嵊州市谷来镇榆树村"
    },
    {
        name: "嵊州市谷来镇田良村",
        content: [
            { name: "虞舜传说", audio: "" },
        ],
        address: "浙江省嵊州市谷来镇田良村"
    },
    {
        name: "谷来镇、黄龙湾、崇仁广利",
        content: [
            { name: "紫砂烧制技艺", audio: "" },
        ],
        address: "浙江省嵊州市谷来镇"
    },
    {
        name: "绍兴博物馆",
        content: [
            { name: "会稽铜镜制造技艺", audio: "" },
            { name: "越医文化", audio: "" },
            { name: "徐文长故事", audio: "" },
        ],
        address: "浙江省绍兴市越城区偏门直街75号",
    },
    {
        name: "柯桥区平水镇",
        content: [
            { name: "绍兴石宕采凿技艺", audio: "" },
            { name: "平水珠茶制作技艺", audio: "" },
        ],
        address: "浙江省绍兴市柯桥区平水镇",
    },
    {
        name: "诸暨市大唐街道(原草塔镇)",
        content: [
            { name: "棕编", audio: "" },
            { name: "草塔镇", audio: "" },
            { name: "线狮", audio: "" },
        ],
        address: "浙江省绍兴市柯桥区平水镇",
    },
    {
        name: "上虞区曹娥街道孝女庙村",
        content: [
            { name: "曹娥庙会", audio: "" },
        ],
        address: "浙江省绍兴市上虞区曹娥街道孝女庙村"
    },
    {
        name: "越城区八字桥直街",
        content: [
            { name: "八字桥", audio: "" },
            { name: "八字桥戏台", audio: "" },
            { name: "绍兴石桥营造技艺", audio: "" },
        ],
        address: "浙江省绍兴市越城区八字桥直街",
    },
    {
        name: "柯桥区湖塘街道",
        content: [
            { name: "绍兴清音班", audio: "" },
            { name: "萧山花边制作技艺", audio: "" },
            { name: "绍兴酱油传统酿造技艺", audio: "" },
        ],
        address: "浙江省绍兴市柯桥区湖塘街道",
    },
];
// http://127.0.0.1:5500/map.html
// 初始化三步
function initMap() {
    var map = new BMap.Map("container");
    // point-地图中心； 15放大倍数-级别（一般3-19）
    map.centerAndZoom(new BMap.Point(120.59, 29.9), 11);

    // 鼠标滚轮缩放
    map.enableScrollWheelZoom(true);
    // 添加控件
    map.addControl(new BMap.ScaleControl());// 添加比例尺控件
    map.addControl(new BMap.NavigationControl());// 添加缩放控件
    // 添加城市列表控件到右上角   
    map.addControl(new BMap.CityListControl({
        anchor: BMAP_ANCHOR_TOP_RIGHT,
        offset: new BMap.Size(10, 10)
    }));

    // 实现 非遗名称.mp3
    addresses.forEach(address => {
        address.content.forEach(item => {
            const safeName = item.name.replace(/[\/\\:*?"<>|]/g, '_');
            item.audio = `audio/${safeName}.mp3`;
        });
    });

    // 地址解析
    //创建地址解析器实例
    var myGeo = new BMap.Geocoder();
    addresses.forEach(function (place, index) {
        myGeo.getPoint(place.address, function (point) {
            if (point) {
                // 创建Marker
                var marker = new BMap.Marker(point);

                const audioState = {
                    audio: null,
                    isPlaying: false,
                    progressInterval: null,
                    currentContainerId: null,
                    currentAudioUrl: null
                };

                window.playAudio = function (audioUrl, containerId) {
                    if (audioState.audio && audioState.isPlaying && audioState.currentAudioUrl !== audioUrl) {
                        audioState.audio.pause();
                        clearInterval(audioState.progressInterval);
                        if (audioState.currentContainerId) {
                            const prevProgressBar = document.getElementById(`${audioState.currentContainerId}-progress`);
                            const prevPlayBtn = document.getElementById(`${audioState.currentContainerId}-playBtn`);
                            if (prevPlayBtn) prevPlayBtn.textContent = '播放';
                            if (prevProgressBar) prevProgressBar.style.width = '0%';
                        }
                    }
                    if (audioState.audio && audioState.currentAudioUrl === audioUrl) {
                        audioState.audio.play();
                        audioState.isPlaying = true;

                        const playBtn = document.getElementById(`${containerId}-playBtn`);
                        if (playBtn) playBtn.textContent = '暂停';
                        audioState.progressInterval = setInterval(() => {
                            if (audioState.audio) {
                                const progress = (audioState.audio.currentTime / audioState.audio.duration) * 100;
                                const progressBar = document.getElementById(`${containerId}-progress`);
                                if (progressBar) progressBar.style.width = `${progress}%`;
                            }
                        }, 100);
                        return;
                    }
                    audioState.audio = new Audio(audioUrl);
                    audioState.isPlaying = true;
                    audioState.currentContainerId = containerId;
                    audioState.currentAudioUrl = audioUrl;

                    const progressBar = document.getElementById(`${containerId}-progress`);
                    const playBtn = document.getElementById(`${containerId}-playBtn`);
                    if (playBtn) playBtn.textContent = '暂停';

                    audioState.audio.play().catch(e => console.log('音频播放失败:', e));
                    audioState.progressInterval = setInterval(() => {
                        if (audioState.audio) {
                            const progress = (audioState.audio.currentTime / audioState.audio.duration) * 100;
                            if (progressBar) progressBar.style.width = `${progress}%`;
                        }
                    }, 100);

                    audioState.audio.onended = function () {
                        clearInterval(audioState.progressInterval);
                        audioState.isPlaying = false;
                        const playBtn = document.getElementById(`${containerId}-playBtn`);
                        if (playBtn) playBtn.textContent = '播放';
                        if (progressBar) progressBar.style.width = '0%';
                    };
                };

                window.toggleAudio = function (containerId, audioUrl) {
                    if (!audioState.audio || audioState.currentAudioUrl !== audioUrl) {
                        playAudio(audioUrl, containerId);
                        return;
                    }

                    const progressBar = document.getElementById(`${containerId}-progress`);
                    const playBtn = document.getElementById(`${containerId}-playBtn`);

                    if (audioState.isPlaying) {
                        audioState.audio.pause();
                        clearInterval(audioState.progressInterval);
                        audioState.isPlaying = false;
                        if (playBtn) playBtn.textContent = '播放';
                    } else {
                        audioState.audio.play();
                        audioState.isPlaying = true;
                        if (playBtn) playBtn.textContent = '暂停';

                        audioState.progressInterval = setInterval(() => {
                            if (audioState.audio) {
                                const progress = (audioState.audio.currentTime / audioState.audio.duration) * 100;
                                if (progressBar) progressBar.style.width = `${progress}%`;
                            }
                        }, 100);
                    }
                };

                // 创建信息窗口
                // 为Marker添加点击事件，点击时打开信息窗口
                var content = `
                <div>
                    <h4>${place.name}</h4>
                    <div style="margin-top:10px;">
                        ${place.content.map((item, i) => {
                    const containerId = `audio-${index}-${i}`;
                    return `
                        <div style="margin: 8px 0;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <span style="flex:1;">${item.name}</span>
                                <button id="${containerId}-playBtn" onclick="toggleAudio('${containerId}', '${item.audio}')"
                                    style="padding: 3px 10px; background: #1E90FF; color: white; border: none; 
                                        border-radius: 4px; cursor: pointer; font-size: 12px;">
                                播放</button>
                            </div>
                            <!-- 新增进度条容器 -->
                            <div style="margin-top: 5px; height: 4px; background: #ddd; border-radius: 2px;">
                                <div id="${containerId}-progress" style="height: 100%; width: 0%; background: #1E90FF; border-radius: 2px;"></div>
                            </div>
                        </div>
                    `;
                }).join('')}
                    </div>
                </div>
            `;

                marker.addEventListener('click', function () {
                    map.openInfoWindow(
                        new BMap.InfoWindow(content, {
                        }),
                        point
                    );
                });
                // 将Marker添加到地图上
                map.addOverlay(marker);
            } else {
                console.log('无法解析地址：' + address);
            }
        });
    });

    // 搜索功能
    // 获取DOM元素
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const resultsDiv = document.getElementById('results');

    // 搜索函数
    function performSearch() {
        resultsDiv.innerHTML = "";
        document.getElementById('results').style.display = 'block';
        const searchTerm = searchInput.value.trim().toLowerCase();

        if (searchTerm === '') {
            return;
        }

        // 过滤数组
        const filteredResults = addresses.map(address => {
            return {
                ...address,
                content: address.content.filter(item =>
                    item.name.includes(searchTerm)
                )
            };
        }).filter(address => address.content.length > 0); // 只保留有匹配结果的地址

        if (filteredResults.length === 0) {
            // resultsDiv.innerHTML = '没有找到匹配的结果';
        } else {
            let htmlContent = '';

            filteredResults.forEach(address => {
                address.content.forEach(item => {
                    const regex = new RegExp(searchTerm, 'gi');
                    const highlightedName = item.name.replace(regex, match =>
                        `<span class="highlight">${match}</span>`
                    );
                    htmlContent += `<div class="content-item data-address="${address.address}"
                 onclick="flyToAddress('${address.address}')"> 
                        <p>${highlightedName}</p></div>`;

                });
            });

            resultsDiv.innerHTML = htmlContent;
        }
    }

    // 添加这个函数到全局作用域   
    window.flyToAddress = function (address) {
        document.getElementById('results').style.display = 'none';
        var geocoder = new BMap.Geocoder();
        geocoder.getPoint(address, function (point) {
            if (point) {
                searchInput.value = ''
                map.centerAndZoom(point, 17);
                marker.openInfoWindow(infoWindow);
            } else {
                alert("无法解析该地址");
            }
        }, "绍兴市");
    };

    // 监听 input 事件（每次输入变化时触发）
    // let searchTimer;
    // searchInput.addEventListener('input', function (e) {
    //     const query = e.target.value.trim();

    //     clearTimeout(searchTimer);
    //     searchTimer = setTimeout(() => {
    //         if (query.length > 0) {
    //             performSearch();
    //         } else {
    //             document.getElementById('results').innerHTML = '';   
    //         }
    //     }, 300);
    // });

    // 绑定按钮点击事件
    searchButton.addEventListener('click', performSearch);

    // 绑定回车键事件
    searchInput.addEventListener('keyup', function (event) {
        if (event.key === 'Enter') {
            performSearch();
        }
    });
    map.addEventListener('click', function () {
        document.getElementById('results').style.display = 'none';
    });
}
// alert("如果不能移动地图请刷新")
